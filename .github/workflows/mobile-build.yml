name: Build Mobile Installers

on:
  push:
    branches: [main]
    tags:
      - 'mobile-v*'
    paths:
      - 'mobile-app/**'
      - '.github/workflows/mobile-build.yml'
  pull_request:
    branches: [main]
    paths:
      - 'mobile-app/**'
      - '.github/workflows/mobile-build.yml'
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Platforms to build (all, android, ios)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - android
          - ios

permissions:
  contents: write

# Prevent concurrent builds of the same ref
concurrency:
  group: mobile-build-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'
  GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx2048m" -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true'

jobs:
  quality-checks:
    name: Code Quality & Security
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: mobile-app/package-lock.json

      - name: Install dependencies
        working-directory: mobile-app
        run: |
          npm ci --legacy-peer-deps
          # Verify installation succeeded
          if [ ! -d "node_modules" ]; then
            echo "❌ ERROR: node_modules not created after npm ci!"
            exit 1
          fi
          echo "✓ Dependencies installed successfully"

      - name: Run ESLint
        working-directory: mobile-app
        run: npm run lint

      - name: Run TypeScript check
        working-directory: mobile-app
        run: npx tsc --noEmit

      - name: Run tests with coverage
        working-directory: mobile-app
        run: npm test -- --run --coverage
        continue-on-error: true

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: mobile-coverage
          path: mobile-app/coverage/
          retention-days: 7
        if: always()
        continue-on-error: true

      - name: Security audit
        working-directory: mobile-app
        run: |
          echo "Running npm audit with --audit-level=high..."
          echo "This will only fail for HIGH and CRITICAL vulnerabilities."
          npm audit --audit-level=high
          AUDIT_EXIT_CODE=$?
          if [ $AUDIT_EXIT_CODE -eq 0 ]; then
            echo "✓ No high or critical vulnerabilities found"
          else
            echo "❌ High or critical vulnerabilities detected!"
            exit $AUDIT_EXIT_CODE
          fi

      - name: Check for outdated dependencies
        working-directory: mobile-app
        run: npm outdated || true
        continue-on-error: true

  build-android:
    name: Build Android App
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: quality-checks
    if: |
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.platforms == 'all' || 
        github.event.inputs.platforms == 'android')) ||
      github.event_name != 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: mobile-app/package-lock.json

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Gradle cache
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-home-cache-cleanup: true
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Install dependencies
        working-directory: mobile-app
        # Using --legacy-peer-deps due to @capacitor-firebase/messaging peer dependency conflict with @capacitor/core
        run: |
          npm ci --legacy-peer-deps
          # Verify installation succeeded
          if [ ! -d "node_modules" ]; then
            echo "❌ ERROR: node_modules not created after npm ci!"
            exit 1
          fi
          echo "✓ Dependencies installed successfully"

      - name: Build web assets
        working-directory: mobile-app
        run: npm run build

      - name: Verify build output
        working-directory: mobile-app
        run: |
          if [ ! -d "dist" ]; then
            echo "❌ ERROR: dist directory not found after build!"
            exit 1
          fi
          echo "✓ Build output verified: dist directory exists"
          echo "Build artifacts:"
          ls -lh dist/ | head -10

      - name: Verify Capacitor configuration
        working-directory: mobile-app
        run: |
          if [ ! -f "capacitor.config.ts" ]; then
            echo "❌ ERROR: capacitor.config.ts not found!"
            exit 1
          fi
          echo "✓ Capacitor configuration found"
          echo "Capacitor app info:"
          grep -E "appId|appName" capacitor.config.ts || echo "Could not extract app info"

      - name: Sync Capacitor Android
        working-directory: mobile-app
        run: npx cap sync android

      - name: Verify Android project structure
        working-directory: mobile-app
        run: |
          if [ ! -d "android" ]; then
            echo "❌ ERROR: android directory not found after sync!"
            exit 1
          fi
          if [ ! -f "android/gradlew" ]; then
            echo "❌ ERROR: gradlew not found in android directory!"
            exit 1
          fi
          echo "✓ Android project structure verified"

      - name: Grant execute permission for gradlew
        working-directory: mobile-app/android
        run: |
          chmod +x gradlew
          echo "✓ Gradle wrapper is executable"
          # Verify gradlew exists and is valid
          if [ ! -f "gradlew" ]; then
            echo "❌ ERROR: gradlew file not found!"
            exit 1
          fi

      - name: Clean Gradle build cache (if exists)
        working-directory: mobile-app/android
        run: |
          if [ -d "app/build" ]; then
            echo "Cleaning existing build directory..."
            ./gradlew clean
          fi
        continue-on-error: true

      - name: Build Debug APK
        working-directory: mobile-app/android
        run: |
          echo "Building Debug APK..."
          ./gradlew assembleDebug --build-cache --parallel --stacktrace
          if [ $? -ne 0 ]; then
            echo "❌ ERROR: Debug APK build failed!"
            exit 1
          fi
          echo "✓ Debug APK built successfully"

      - name: Build Release AAB (unsigned)
        working-directory: mobile-app/android
        run: ./gradlew bundleRelease --build-cache --parallel
        continue-on-error: true

      - name: Get APK/AAB info
        working-directory: mobile-app/android
        run: |
          echo "### Build Artifacts Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
            APK_SIZE=$(du -h app/build/outputs/apk/debug/app-debug.apk | cut -f1)
            APK_SHA256=$(sha256sum app/build/outputs/apk/debug/app-debug.apk | cut -d' ' -f1)
            echo "**Debug APK:**" >> $GITHUB_STEP_SUMMARY
            echo "- Size: $APK_SIZE" >> $GITHUB_STEP_SUMMARY
            echo "- SHA256: \`$APK_SHA256\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ **Debug APK not found**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "app/build/outputs/bundle/release/app-release.aab" ]; then
            AAB_SIZE=$(du -h app/build/outputs/bundle/release/app-release.aab | cut -f1)
            AAB_SHA256=$(sha256sum app/build/outputs/bundle/release/app-release.aab | cut -d' ' -f1)
            echo "**Release AAB:**" >> $GITHUB_STEP_SUMMARY
            echo "- Size: $AAB_SIZE" >> $GITHUB_STEP_SUMMARY
            echo "- SHA256: \`$AAB_SHA256\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ **Release AAB not built** (requires signing configuration)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: android-debug-apk
          path: mobile-app/android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 7
          if-no-files-found: error

      - name: Upload Release AAB (if built)
        uses: actions/upload-artifact@v4
        with:
          name: android-release-aab
          path: mobile-app/android/app/build/outputs/bundle/release/app-release.aab
          retention-days: 7
          if-no-files-found: ignore
        continue-on-error: true

      - name: Upload to Release (if tag)
        if: startsWith(github.ref, 'refs/tags/mobile-v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            mobile-app/android/app/build/outputs/apk/debug/app-debug.apk
            mobile-app/android/app/build/outputs/bundle/release/app-release.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

  build-ios:
    name: Build iOS App
    runs-on: macos-latest
    timeout-minutes: 45
    needs: quality-checks
    if: |
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.platforms == 'all' || 
        github.event.inputs.platforms == 'ios')) ||
      github.event_name != 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: mobile-app/package-lock.json

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            mobile-app/ios/App/Pods
            ~/Library/Caches/CocoaPods
            ~/.cocoapods
          key: ${{ runner.os }}-pods-${{ hashFiles('mobile-app/ios/App/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install dependencies
        working-directory: mobile-app
        # Using --legacy-peer-deps due to @capacitor-firebase/messaging peer dependency conflict with @capacitor/core
        run: |
          npm ci --legacy-peer-deps
          # Verify installation succeeded
          if [ ! -d "node_modules" ]; then
            echo "❌ ERROR: node_modules not created after npm ci!"
            exit 1
          fi
          echo "✓ Dependencies installed successfully"

      - name: Build web assets
        working-directory: mobile-app
        run: npm run build

      - name: Verify build output
        working-directory: mobile-app
        run: |
          if [ ! -d "dist" ]; then
            echo "❌ ERROR: dist directory not found after build!"
            exit 1
          fi
          echo "✓ Build output verified: dist directory exists"
          echo "Build artifacts:"
          ls -lh dist/ | head -10

      - name: Verify Capacitor configuration
        working-directory: mobile-app
        run: |
          if [ ! -f "capacitor.config.ts" ]; then
            echo "❌ ERROR: capacitor.config.ts not found!"
            exit 1
          fi
          echo "✓ Capacitor configuration found"

      - name: Add iOS platform and configure deployment target
        working-directory: mobile-app
        run: |
          if [ ! -d "ios" ]; then
            echo "iOS platform not found, adding..."
            # Try to add iOS platform - it may fail during pod install due to deployment target issues
            # The platform structure will still be created, allowing us to fix the Podfile before retry
            npx cap add ios || {
              echo "⚠️ Initial iOS platform add failed (expected if deployment target conflicts with pod requirements)"
              echo "Platform structure should still be created - will configure Podfile and retry..."
            }
          else
            echo "iOS platform already exists, skipping add step"
          fi
          
          # Ensure deployment target is set correctly in Podfile
          if [ -f "ios/App/Podfile" ]; then
            echo "Configuring Podfile deployment target to iOS 14.0..."
            # Check if platform line exists
            if grep -q "platform :ios" ios/App/Podfile; then
              # Update existing platform line to iOS 14.0
              # Use perl for cross-platform compatibility (works on both macOS and Linux)
              perl -i -pe "s/platform :ios, '[^']*'/platform :ios, '14.0'/" ios/App/Podfile
            else
              # Add platform line at the beginning of the file
              echo "platform :ios, '14.0'" | cat - ios/App/Podfile > ios/App/Podfile.tmp
              mv ios/App/Podfile.tmp ios/App/Podfile
            fi
            
            echo "✓ Podfile deployment target configured:"
            grep "platform :ios" ios/App/Podfile || echo "⚠️ Could not find platform line"
          else
            echo "❌ ERROR: Podfile not found after iOS platform add!"
            echo "Directory structure:"
            ls -la ios/ 2>/dev/null || echo "ios/ directory not found"
            exit 1
          fi

      - name: Sync Capacitor iOS and install pods
        working-directory: mobile-app
        run: npx cap sync ios

      - name: Build iOS app (Debug)
        working-directory: mobile-app/ios/App
        run: |
          set -o pipefail
          echo "Starting iOS build for simulator..."
          xcodebuild \
            -workspace App.xcworkspace \
            -scheme App \
            -configuration Debug \
            -sdk iphonesimulator \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO 2>&1 | tee build.log
          
          echo "✓ iOS build completed successfully"
        continue-on-error: true

      - name: Get build info
        working-directory: mobile-app
        run: |
          echo "### iOS Build Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "ios/App/build/Build/Products/Debug-iphonesimulator" ]; then
            APP_SIZE=$(du -sh ios/App/build/Build/Products/Debug-iphonesimulator/*.app 2>/dev/null | cut -f1 || echo "N/A")
            echo "**Build artifacts:**" >> $GITHUB_STEP_SUMMARY
            echo "- App bundle size: $APP_SIZE" >> $GITHUB_STEP_SUMMARY
            echo "- Configuration: Debug (Simulator)" >> $GITHUB_STEP_SUMMARY
            echo "- Deployment target: iOS 14.0+" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Build artifacts not found. Check build logs." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create IPA archive info
        working-directory: mobile-app
        run: |
          echo "# iOS Build Information" > ios-build-info.txt
          echo "" >> ios-build-info.txt
          echo "Build completed at: $(date)" >> ios-build-info.txt
          echo "Commit: ${{ github.sha }}" >> ios-build-info.txt
          echo "" >> ios-build-info.txt
          echo "## Note" >> ios-build-info.txt
          echo "iOS builds require code signing with Apple Developer certificates." >> ios-build-info.txt
          echo "For production builds:" >> ios-build-info.txt
          echo "1. Open the project in Xcode on a Mac" >> ios-build-info.txt
          echo "2. Configure signing with your Apple Developer account" >> ios-build-info.txt
          echo "3. Archive the app (Product > Archive)" >> ios-build-info.txt
          echo "4. Upload to App Store Connect or export IPA" >> ios-build-info.txt
          echo "" >> ios-build-info.txt
          echo "Refer to mobile-app/BUILD_GUIDE.md for detailed instructions." >> ios-build-info.txt

      - name: Upload iOS build info
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-info
          path: mobile-app/ios-build-info.txt
          retention-days: 7
          if-no-files-found: warn

      - name: Upload iOS app bundle (if available)
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-bundle
          path: mobile-app/ios/App/build/Build/Products/Debug-iphonesimulator/*.app
          retention-days: 7
          if-no-files-found: ignore
        continue-on-error: true

  create-mobile-release-summary:
    name: Create Mobile Release Summary
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build-android, build-ios]
    if: always() && startsWith(github.ref, 'refs/tags/mobile-v')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate release summary
        run: |
          echo "# LotoLink Mobile Application Release" > mobile_release_summary.md
          echo "" >> mobile_release_summary.md
          echo "## Release Information" >> mobile_release_summary.md
          echo "- **Version:** ${GITHUB_REF#refs/tags/mobile-v}" >> mobile_release_summary.md
          echo "- **Date:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> mobile_release_summary.md
          echo "- **Commit:** ${{ github.sha }}" >> mobile_release_summary.md
          echo "" >> mobile_release_summary.md
          echo "## Available Builds" >> mobile_release_summary.md
          echo "" >> mobile_release_summary.md
          
          echo "### Android" >> mobile_release_summary.md
          echo "" >> mobile_release_summary.md
          if [ -d "artifacts/android-debug-apk" ]; then
            echo "**Debug APK (for testing):**" >> mobile_release_summary.md
            cd artifacts/android-debug-apk
            for file in *.apk; do
              if [ -f "$file" ]; then
                SIZE=$(du -h "$file" | cut -f1)
                echo "- \`$file\` ($SIZE)" >> ../../mobile_release_summary.md
              fi
            done
            cd ../..
          fi
          
          if [ -d "artifacts/android-release-aab" ]; then
            echo "" >> mobile_release_summary.md
            echo "**Release AAB (for Google Play):**" >> mobile_release_summary.md
            cd artifacts/android-release-aab
            for file in *.aab; do
              if [ -f "$file" ]; then
                SIZE=$(du -h "$file" | cut -f1)
                echo "- \`$file\` ($SIZE)" >> ../../mobile_release_summary.md
              fi
            done
            cd ../..
          fi
          
          echo "" >> mobile_release_summary.md
          echo "### iOS" >> mobile_release_summary.md
          echo "" >> mobile_release_summary.md
          echo "iOS builds require Apple Developer certificates for code signing." >> mobile_release_summary.md
          echo "The workflow has prepared the iOS project. To create a distributable IPA:" >> mobile_release_summary.md
          echo "" >> mobile_release_summary.md
          echo "1. Clone the repository and checkout this tag" >> mobile_release_summary.md
          echo "2. Follow the iOS build instructions in \`mobile-app/BUILD_GUIDE.md\`" >> mobile_release_summary.md
          echo "3. Use Xcode to archive and export the IPA" >> mobile_release_summary.md
          echo "" >> mobile_release_summary.md
          
          echo "## Installation Instructions" >> mobile_release_summary.md
          echo "" >> mobile_release_summary.md
          echo "### Android" >> mobile_release_summary.md
          echo "" >> mobile_release_summary.md
          echo "**Debug APK (Testing):**" >> mobile_release_summary.md
          echo "1. Download the \`app-debug.apk\` file" >> mobile_release_summary.md
          echo "2. Enable \"Install from Unknown Sources\" on your Android device" >> mobile_release_summary.md
          echo "3. Transfer the APK to your device and install" >> mobile_release_summary.md
          echo "" >> mobile_release_summary.md
          echo "**Release AAB (Production):**" >> mobile_release_summary.md
          echo "1. Sign the AAB with your release keystore" >> mobile_release_summary.md
          echo "2. Upload to Google Play Console" >> mobile_release_summary.md
          echo "3. Follow Google Play's submission process" >> mobile_release_summary.md
          echo "" >> mobile_release_summary.md
          
          echo "### iOS" >> mobile_release_summary.md
          echo "" >> mobile_release_summary.md
          echo "1. Build and archive the app in Xcode (macOS required)" >> mobile_release_summary.md
          echo "2. Upload to App Store Connect" >> mobile_release_summary.md
          echo "3. Submit for App Store review" >> mobile_release_summary.md
          echo "" >> mobile_release_summary.md
          
          echo "## Requirements" >> mobile_release_summary.md
          echo "" >> mobile_release_summary.md
          echo "### Android" >> mobile_release_summary.md
          echo "- Minimum SDK: API 22 (Android 5.1)" >> mobile_release_summary.md
          echo "- Target SDK: API 34 (Android 14)" >> mobile_release_summary.md
          echo "- Architecture: ARM, ARM64, x86, x86_64" >> mobile_release_summary.md
          echo "" >> mobile_release_summary.md
          echo "### iOS" >> mobile_release_summary.md
          echo "- Minimum version: iOS 14.0+" >> mobile_release_summary.md
          echo "- Devices: iPhone, iPad" >> mobile_release_summary.md
          echo "" >> mobile_release_summary.md
          
          echo "## Documentation" >> mobile_release_summary.md
          echo "" >> mobile_release_summary.md
          echo "- [Build Guide](mobile-app/BUILD_GUIDE.md)" >> mobile_release_summary.md
          echo "- [Deployment Guide](mobile-app/DEPLOYMENT_GUIDE.md)" >> mobile_release_summary.md
          echo "- [Quick Start](mobile-app/QUICKSTART.md)" >> mobile_release_summary.md
          echo "" >> mobile_release_summary.md
          
          echo "---" >> mobile_release_summary.md
          echo "" >> mobile_release_summary.md
          echo "For support and issues, please visit the repository." >> mobile_release_summary.md
          
          cat mobile_release_summary.md

      - name: Upload release summary
        uses: actions/upload-artifact@v4
        with:
          name: mobile-release-summary
          path: mobile_release_summary.md
          retention-days: 30

      - name: Add summary to release
        if: startsWith(github.ref, 'refs/tags/mobile-v')
        uses: softprops/action-gh-release@v1
        with:
          body_path: mobile_release_summary.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
