version: '3.8'

# ============================================
# Docker Compose Override para PRODUCCIÓN
# ============================================
# Este archivo se usa junto con docker-compose.yml
# Uso: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# ============================================

services:
  # PostgreSQL - Configuración de producción
  postgres:
    restart: always
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    # Recursos limitados
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    # Healthcheck más frecuente
    healthcheck:
      interval: 30s
      timeout: 10s
      retries: 3
  
  # Redis - Configuración de producción
  redis:
    restart: always
    # Agregar contraseña en producción
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD", "redis-cli", "--pass", "${REDIS_PASSWORD}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
  
  # RabbitMQ - Configuración de producción
  rabbitmq:
    restart: always
    environment:
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
  
  # Backend - Configuración de producción
  backend:
    restart: always
    environment:
      NODE_ENV: production
      # Deshabilitar mocks en producción
      USE_MOCK_BANCA: "false"
      USE_MOCK_PAYMENTS: "false"
      USE_MOCK_LOTTERY_RESULTS: "false"
      # Logging optimizado
      LOG_LEVEL: info
    # No montar código fuente en producción
    volumes:
      - backend_logs:/app/logs
    # Recursos
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    # Healthcheck
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  
  # Adminer - Deshabilitar en producción
  # Para habilitar temporalmente en producción para debugging:
  # docker-compose --profile debug up -d adminer
  adminer:
    profiles:
      - debug
    restart: "no"

volumes:
  # Volumen persistente para logs del backend
  backend_logs:

# ============================================
# NOTAS DE SEGURIDAD
# ============================================
# 1. Asegúrate de que todas las variables ${VAR} estén en .env
# 2. Usa contraseñas fuertes para POSTGRES_PASSWORD, REDIS_PASSWORD, RABBITMQ_PASSWORD
# 3. Configura un reverse proxy (Nginx) delante de estos servicios
# 4. No expongas puertos de base de datos al exterior
# 5. Configura backups automáticos de postgres_data
# 6. Monitorea logs regularmente
# 7. Implementa rotación de logs
# 8. Considera usar secrets de Docker Swarm en lugar de variables de entorno
